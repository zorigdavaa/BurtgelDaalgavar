@page "/transport"

@inject IProductService baraaservice;
@inject IWarehouseService warehouseService;
@inject JsInterop js;

<PageTitle>Transport</PageTitle>

@if (WareHouses == null)
{
    <h3>Loading ...</h3>
}
else
{
    <div>
        <h3>WareHouses</h3>
        <table class="table">
            @*            <thead>
        <tr>
        <th>WareHouse Name</th>
        <th>Items</th>
        </tr>
        </thead>*@
            <tbody>
                @foreach (var wareHouse in WareHouses)
                {
                    @*                    <tr>
            <td>@wareHouse.Name Warehouse</td>
            <td></td>
            </tr>*@
                    <tr>
                        <td colspan="2">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>
                                            <div>@wareHouse.Name items</div>

                                            <div>
                                                <button @onclick="()=> OnAddButtonClick(wareHouse.Id)">Add Products</button>
                                            </div>
                                        </th>
                                        <th>Code</th>
                                        <th>Price</th>
                                        <th>Count</th>
                                        <th>Unit</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in wareHouse.Items)
                                    {
                                        <tr>
                                            <td>@item.Name</td>
                                            <td>@item.Code</td>
                                            <td>@item.Price</td>
                                            <td>@item.Count</td>
                                            <td>@item.Meas</td>
                                            <td>
                                                <button>Sell</button>
                                                <button>Transfer</button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <Modal @ref="AddModal" OnSaveChanges="OnModalAddSave">
            <Title>
                Add item to Warehouse
            </Title>
            <Body>
                <div class="container">

                    <div class="row">
                        <div class="col col-sm-12">
                            <select @bind="ModalSelectedItemCode" style="width: 25%">
                                @foreach (var item in Baraanuud)
                                {
                                    <option value="@item.Code">@item.Code</option>
                                }
                            </select>
                        </div>


                    </div>
                    <div class="row">
                        <div class="col">
                            <label>Count</label>
                        </div>
                        <div class="col">
                            <input type="number" @bind-value="modalCount">
                        </div>
                    </div>
                    @if (ModalBaraa != null)
                    {

                        <div class="row">
                            <div class="col">
                                <label>Name</label>
                            </div>
                            <div class="col">

                                <label>@ModalBaraa.Name</label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <label>Price</label>
                            </div>
                            <div class="col">

                                <label>@ModalBaraa.Price</label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <label>Unit of Measure</label>
                            </div>
                            <div class="col">

                                <label>@ModalBaraa.Meas</label>
                            </div>
                        </div>
                    }
                </div>
            </Body>
        </Modal>
        <Modal @ref="TransferModal" OnSaveChanges="OnModalAddSave">
            <Title>
                Add item to Warehouse
            </Title>
            <Body>
                <div class="container">

                    <div class="row">
                        <div class="col col-sm-12">
                            <select @bind="ModalSelectedItemCode" style="width: 25%">
                                @foreach (var item in Baraanuud)
                                {
                                    <option value="@item.Code">@item.Code</option>
                                }
                            </select>
                        </div>


                    </div>
                    <div class="row">
                        <div class="col">
                            <label>Count</label>
                        </div>
                        <div class="col">
                            <input type="number" @bind-value="modalCount">
                        </div>
                    </div>
                    @if (ModalBaraa != null)
                    {

                        <div class="row">
                            <div class="col">
                                <label>Name</label>
                            </div>
                            <div class="col">

                                <label>@ModalBaraa.Name</label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <label>Price</label>
                            </div>
                            <div class="col">

                                <label>@ModalBaraa.Price</label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <label>Unit of Measure</label>
                            </div>
                            <div class="col">

                                <label>@ModalBaraa.Meas</label>
                            </div>
                        </div>
                    }
                </div>
            </Body>
        </Modal>
    </div>
}



@code {
    WareHouse wareHouse = new WareHouse();
    private List<WareHouse>? WareHouses;
    private List<Product>? Baraanuud;
    Modal AddModal;
    Modal TransferModal;
    Product ModalBaraa = new Product();
    private int modalSelectedItemCode = 1;
    public int ModalSelectedItemCode
    {
        get { return modalSelectedItemCode; }
        set
        {
            if (modalSelectedItemCode != value)
            {
                RefreshModalBaraa(value);
            }
            modalSelectedItemCode = value;
        }
    }

    int modalCount = 0;//Used for product count on modal

    protected override async Task OnInitializedAsync()
    {
        await warehouseService.GetWareHousesWithItemsAsync();
        await baraaservice.GetItemsAsync();
        WareHouses = warehouseService.WareHouses;
        Baraanuud = baraaservice.Items;
    }
    int lastClickedWarehouseId = 0;
    public void OnAddButtonClick(int warehouseId)
    {
        lastClickedWarehouseId = warehouseId;
        RefreshModalBaraa(ModalSelectedItemCode);
        AddModal.Open();
    }
    public async Task OnModalAddSave()
    {
        if (ModalBaraa != null && Baraanuud.Any(x => x.Code == ModalBaraa.Code) && modalCount > 0)
        {
            TransactionProd prod = new TransactionProd();
            prod.ProductName = ModalBaraa.Name;
            prod.ProductPrice = ModalBaraa.Price;
            prod.ProductMeas = ModalBaraa.Meas;
            prod.ProductCount = modalCount;
            prod.ToWareHouseId = lastClickedWarehouseId;
            prod.FromWareHouseId = 0;
            prod.TransactionDate = DateTime.Now;
            prod.ProductCode = ModalBaraa.Code;
            await warehouseService.AddProductToWareHouse(prod);
            await warehouseService.GetWareHousesWithItemsAsync();
            WareHouses = warehouseService.WareHouses;
        }
        AddModal.Close();
        //await baraaservice.EditItem(Modal.editingBaraa);
        //Modal.ResetBaraa();
    }
    void RefreshModalBaraa(int val)
    {
        if (Baraanuud != null && Baraanuud.Any())
        {
            ModalBaraa = Baraanuud.FirstOrDefault(x => x.Code == val);
        }
    }
}

